// firestore.rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ------------------------------
       Helpers
       NOTE:
       - v11 data model was single-org using users/{uid}.organizationId
       - v13 data model introduces memberships + organizations/{orgId}/members/{uid}
       - Existing projects may have:
         (a) memberships with random IDs (legacy)
         (b) membership docs with {active:true} instead of {status:"active"}
         (c) users/{uid}.organizationId populated (legacy primary org)
       These helpers intentionally accept ALL compatible variants so that v13
       code can read tenant data (tasks/incidents/sites/etc.) without breaking
       existing datasets.
    --------------------------------- */
    function isSignedIn() { return request.auth != null; }

    // --- Legacy profile (single-org)
    function userProfile(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function legacyOrgId() {
      return isSignedIn() ? (userProfile(request.auth.uid).data.organizationId) : null;
    }

    function legacyRole() {
      return isSignedIn() ? (userProfile(request.auth.uid).data.role) : null;
    }

    function legacyActiveInOrg(orgId) {
      return isSignedIn()
        && legacyOrgId() != null
        && legacyOrgId() == orgId
        && (userProfile(request.auth.uid).data.active == true || userProfile(request.auth.uid).data.active == null);
    }

    function organizationIsActive(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)).data.isActive == true
        && (
          get(/databases/$(database)/documents/organizations/$(orgId)).data.status == null
          || (
            get(/databases/$(database)/documents/organizations/$(orgId)).data.status != "suspended"
            && get(/databases/$(database)/documents/organizations/$(orgId)).data.status != "deleted"
          )
        );
    }

    // --- Org members (preferred, deterministic id = uid)
    function memberDoc(uid, orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(uid));
    }

    function hasMember(orgId) {
      return isSignedIn() && exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }

    function memberStatus(orgId) {
      return hasMember(orgId)
        ? (
            memberDoc(request.auth.uid, orgId).data.status != null
              ? memberDoc(request.auth.uid, orgId).data.status
              : (memberDoc(request.auth.uid, orgId).data.active == true ? "active" : "pending")
          )
        : null;
    }

    function memberRole(orgId) {
      return hasMember(orgId) ? (memberDoc(request.auth.uid, orgId).data.role) : null;
    }

    // --- Membership doc (preferred deterministic id = uid_orgId; kept for compatibility)
    function membershipId(uid, orgId) {
      return uid + "_" + orgId;
    }

    function membershipDoc(uid, orgId) {
      return get(/databases/$(database)/documents/memberships/$(membershipId(uid, orgId)));
    }

    function hasMembershipById(orgId) {
      return isSignedIn() && exists(/databases/$(database)/documents/memberships/$(membershipId(request.auth.uid, orgId)));
    }

    function membershipStatusById(orgId) {
      return hasMembershipById(orgId)
        ? (
            membershipDoc(request.auth.uid, orgId).data.status != null
              ? membershipDoc(request.auth.uid, orgId).data.status
              : (membershipDoc(request.auth.uid, orgId).data.active == true ? "active" : "pending")
          )
        : null;
    }

    function membershipRoleById(orgId) {
      return hasMembershipById(orgId) ? (membershipDoc(request.auth.uid, orgId).data.role) : null;
    }

    // --- Unified checks
    function isActiveMember(orgId) {
      return isSignedIn() && organizationIsActive(orgId) && (
        (hasMember(orgId) && memberStatus(orgId) == "active")
        || (hasMembershipById(orgId) && membershipStatusById(orgId) == "active")
        || (!hasMember(orgId) && !hasMembershipById(orgId) && legacyActiveInOrg(orgId))
      );
    }

    function roleInOrg(orgId) {
      return hasMember(orgId)
        ? memberRole(orgId)
        : (hasMembershipById(orgId)
            ? membershipRoleById(orgId)
            : (legacyOrgId() == orgId ? legacyRole() : null));
    }

    function isSuperAdminInOrg(orgId) {
      return isActiveMember(orgId) && roleInOrg(orgId) == "super_admin";
    }

    function isAdminInOrg(orgId) {
      return isActiveMember(orgId) && (roleInOrg(orgId) == "admin" || roleInOrg(orgId) == "super_admin");
    }

    function isManagerInOrg(orgId) {
      return isActiveMember(orgId) && (roleInOrg(orgId) == "super_admin" || roleInOrg(orgId) == "admin" || roleInOrg(orgId) == "maintenance");
    }

    function organizationIdUnchanged() {
      return request.resource.data.organizationId == resource.data.organizationId;
    }

    function organizationIdMatchesPath(orgId) {
      return request.resource.data.organizationId == orgId;
    }

    function resourceOrganizationIdMatchesPath(orgId) {
      return resource.data.organizationId == null || resource.data.organizationId == orgId;
    }

    function roleUnchanged() {
      return request.resource.data.role == resource.data.role;
    }

    /* ------------------------------
       USERS (profile)
       - Only self-access from client.
       - Org changes are performed server-side via Cloud Function.
    --------------------------------- */
    match /users/{userId} {
      // Needed by v13 UI (tasks/incidents assignment, name maps, etc.)
      // Allow reading user docs within the caller's active organization.
      // Note: client queries are always scoped with where('organizationId'=='<activeOrgId>').
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        (resource.data.organizationId != null && isActiveMember(resource.data.organizationId))
      );

      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.organizationId == null;

      allow update: if isSignedIn()
        && request.auth.uid == userId
        && organizationIdUnchanged()
        && roleUnchanged();

      allow delete: if false;
    }

    /* ------------------------------
       MEMBERSHIPS
       - Users can read their own memberships across orgs.
       - Write operations are server-only.
    --------------------------------- */
    match /memberships/{membershipId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create, update, delete: if false;
    }

    /* ------------------------------
       ORGANIZATIONS
       - Block discovery.
       - Read allowed only for active members.
       - Writes server-only.
    --------------------------------- */
    match /organizations/{orgId} {
      allow list: if false;
      allow get: if isActiveMember(orgId);
      allow create, update, delete: if false;

      // Organization-scoped settings
      match /settings/{settingId} {
        allow read: if isSignedIn() && isSuperAdminInOrg(orgId);
        allow write: if false;
      }

      // Organization-scoped resources (v14+ data model)
      match /sites/{siteId} {
        allow read: if isSignedIn() && isActiveMember(orgId) && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn() && isAdminInOrg(orgId) && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId);
      }

      match /assets/{assetId} {
        allow read: if isSignedIn() && isActiveMember(orgId) && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn() && isAdminInOrg(orgId) && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId);
      }

      match /departments/{departmentId} {
        allow read: if isSignedIn() && isActiveMember(orgId) && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn() && isAdminInOrg(orgId) && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId);
      }

      match /tickets/{ticketId} {
        allow read: if isSignedIn() && isActiveMember(orgId) && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn() && isActiveMember(orgId) && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isActiveMember(orgId)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId);
      }

      match /tasks/{taskId} {
        allow read: if isSignedIn() && isActiveMember(orgId) && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn() && isActiveMember(orgId) && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isActiveMember(orgId)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId);
      }

      match /auditLogs/{logId} {
        allow read: if isSignedIn() && isAdminInOrg(orgId);
        allow create: if isSignedIn() && isAdminInOrg(orgId) && organizationIdMatchesPath(orgId);
        allow update, delete: if false;
      }

      // Members snapshot (operational listing)
      match /members/{memberUid} {
        allow read: if isActiveMember(orgId) && (isAdminInOrg(orgId) || request.auth.uid == memberUid);
        allow create, update, delete: if false;
      }

      // Join requests (pending access)
      match /joinRequests/{requestUid} {
        allow get: if isSignedIn() && (
          isSuperAdminInOrg(orgId) ||
          request.auth.uid == requestUid
        );

        allow list: if isSuperAdminInOrg(orgId);

        allow create, update, delete: if false;
      }
    }

    /* ------------------------------
       ORGANIZATIONS PUBLIC
       - Read-only public metadata for signup validation.
       - Writes server-only.
    --------------------------------- */
    match /organizationsPublic/{orgId} {
      allow read: if true;
      allow create, update, delete: if false;
    }

    /* ------------------------------
       SETTINGS
    --------------------------------- */
    match /settings/{settingId} {
      allow read: if isSignedIn() && isSuperAdminInOrg(resource.data.organizationId);
      allow write: if false;
    }

    /* ------------------------------
       TICKETS (legacy root collections)
    --------------------------------- */
    match /tickets/{ticketId} {
      allow read: if isSignedIn() && isActiveMember(resource.data.organizationId);
      allow create: if isSignedIn() && isActiveMember(request.resource.data.organizationId);

      allow update: if isSignedIn()
        && isActiveMember(resource.data.organizationId)
        && organizationIdUnchanged();

      allow delete: if isSignedIn() && isAdminInOrg(resource.data.organizationId);
    }

    /* ------------------------------
       TASKS (legacy root collections)
    --------------------------------- */
    match /tasks/{taskId} {
      allow read: if isSignedIn() && isActiveMember(resource.data.organizationId);
      allow create: if isSignedIn() && isActiveMember(request.resource.data.organizationId);

      allow update: if isSignedIn()
        && isActiveMember(resource.data.organizationId)
        && organizationIdUnchanged();

      allow delete: if isSignedIn() && isAdminInOrg(resource.data.organizationId);
    }

    /* ------------------------------
       SITES / ASSETS / DEPARTMENTS (legacy root collections)
    --------------------------------- */
    match /sites/{siteId} {
      allow read: if isSignedIn() && isActiveMember(resource.data.organizationId);
      allow create: if isSignedIn() && isAdminInOrg(request.resource.data.organizationId);
      allow update: if isSignedIn() && isAdminInOrg(resource.data.organizationId) && organizationIdUnchanged();
      allow delete: if isSignedIn() && isAdminInOrg(resource.data.organizationId);
    }

    match /assets/{assetId} {
      allow read: if isSignedIn() && isActiveMember(resource.data.organizationId);
      allow create: if isSignedIn() && isAdminInOrg(request.resource.data.organizationId);
      allow update: if isSignedIn() && isAdminInOrg(resource.data.organizationId) && organizationIdUnchanged();
      allow delete: if isSignedIn() && isAdminInOrg(resource.data.organizationId);
    }

    match /departments/{departmentId} {
      allow read: if isSignedIn() && isActiveMember(resource.data.organizationId);
      allow create: if isSignedIn() && isAdminInOrg(request.resource.data.organizationId);
      allow update: if isSignedIn() && isAdminInOrg(resource.data.organizationId) && organizationIdUnchanged();
      allow delete: if isSignedIn() && isAdminInOrg(resource.data.organizationId);
    }
  }
}
