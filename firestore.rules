// firestore.rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ------------------------------
       Helpers
       NOTE:
       - Multi-org access is based exclusively on organizations/{orgId}/members/{uid}.
       - Do not rely on users/{uid}.organizationId or legacy memberships for access.
    --------------------------------- */
    function isSignedIn() { return request.auth != null; }

    function isValidOrgId(orgId) {
      return orgId is string && orgId.size() > 0;
    }

    function memberDoc(orgId, uid) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(uid));
    }

    function membershipDoc(orgId, uid) {
      return get(/databases/$(database)/documents/memberships/$(uid + "_" + orgId));
    }

    function isActiveMembership(doc) {
      return doc != null
        && doc.data != null
        && (
          doc.data.status == "active"
          || doc.data.active == true
          || doc.data.isActive == true
        );
    }

    function isActiveMember(orgId, uid) {
      let member = isValidOrgId(orgId) ? memberDoc(orgId, uid) : null;
      let membership = isValidOrgId(orgId) ? membershipDoc(orgId, uid) : null;
      return isSignedIn()
        && (
          isActiveMembership(member)
          || isActiveMembership(membership)
        );
    }

    function activeMemberData(orgId, uid) {
      let member = isValidOrgId(orgId) ? memberDoc(orgId, uid) : null;
      let membership = isValidOrgId(orgId) ? membershipDoc(orgId, uid) : null;
      return isActiveMembership(member)
        ? member.data
        : (isActiveMembership(membership) ? membership.data : null);
    }

    function hasRole(orgId, uid, roles) {
      let member = isValidOrgId(orgId) ? memberDoc(orgId, uid) : null;
      let membership = isValidOrgId(orgId) ? membershipDoc(orgId, uid) : null;
      return isSignedIn()
        && (
          (isActiveMembership(member) && member.data.role in roles && (!('organizationId' in member.data) || member.data.organizationId == orgId))
          || (isActiveMembership(membership) && membership.data.role in roles && (!('organizationId' in membership.data) || membership.data.organizationId == orgId))
        );
    }

    function isSuperAdminInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["super_admin"]);
    }

    function isAdminInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["admin", "super_admin"]);
    }

    // Role groups (basic rentable + backward compatible)
    function isAuditorInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["auditor"]);
    }

    function isOperatorInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["operario"]);
    }

    function isDepartmentHeadInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["jefe_departamento"]);
    }

    function isLocationHeadInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["jefe_ubicacion"]);
    }

    function isMaintenanceOnlyInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["mantenimiento"]);
    }

    function isMaintenanceInOrg(orgId, uid) {
      return hasRole(orgId, uid, [
        "mantenimiento",
        "admin",
        "super_admin",
        "jefe_departamento",
        "jefe_ubicacion"
      ]);
    }

    function organizationIdUnchanged() {
      return !('organizationId' in resource.data)
        || !('organizationId' in request.resource.data)
        || request.resource.data.organizationId == resource.data.organizationId;
    }

    function organizationIdMatchesPath(orgId) {
      return !('organizationId' in request.resource.data)
        || request.resource.data.organizationId == orgId;
    }

    function resourceOrganizationIdMatchesPath(orgId) {
      return !('organizationId' in resource.data)
        || resource.data.organizationId == orgId;
    }

    function organizationIdMatchesDoc(orgId, data) {
      return ('organizationId' in data)
        && data.organizationId == orgId;
    }

    function roleUnchanged() {
      return request.resource.data.role == resource.data.role;
    }

    function accountPlanUnchanged() {
      return request.resource.data.accountPlan == resource.data.accountPlan;
    }

    function createdOrganizationsCountUnchanged() {
      return request.resource.data.createdOrganizationsCount == resource.data.createdOrganizationsCount;
    }

    function createdOrganizationsLimitUnchanged() {
      return request.resource.data.createdOrganizationsLimit == resource.data.createdOrganizationsLimit;
    }

    function demoUsedAtUnchanged() {
      return request.resource.data.demoUsedAt == resource.data.demoUsedAt;
    }

    function userQuotaFieldsUnchanged() {
      return accountPlanUnchanged()
        && createdOrganizationsCountUnchanged()
        && createdOrganizationsLimitUnchanged()
        && demoUsedAtUnchanged();
    }

    function userQuotaFieldsUnset() {
      return request.resource.data.accountPlan == null
        && request.resource.data.createdOrganizationsCount == null
        && request.resource.data.createdOrganizationsLimit == null
        && request.resource.data.demoUsedAt == null;
    }

    function docLocationId(data) {
      return ('locationId' in data)
        ? data.locationId
        : null;
    }

    function docOriginDepartmentId(data) {
      return ('originDepartmentId' in data)
        ? data.originDepartmentId
        : (('departmentId' in data) ? data.departmentId : null);
    }

    function docTargetDepartmentId(data) {
      return ('targetDepartmentId' in data)
        ? data.targetDepartmentId
        : (('departmentId' in data) ? data.departmentId : null);
    }

    function isCreator(uid, data) {
      return ('createdBy' in data) && data.createdBy == uid;
    }

    function isAssignee(uid, data) {
      return ('assignedTo' in data) && data.assignedTo == uid;
    }

    function memberHasDepartment(member, deptId) {
      return member != null
        && deptId != null
        && (
          ('departmentId' in member && member.departmentId == deptId)
          || ('departmentIds' in member && member.departmentIds.hasAny([deptId]))
        );
    }

    function memberHasLocation(member, locationId) {
      return member != null
        && locationId != null
        && (
          ('locationId' in member && member.locationId == locationId)
          || ('locationIds' in member && member.locationIds.hasAny([locationId]))
        );
    }

    function inMemberDepartment(member, data) {
      return memberHasDepartment(member, docOriginDepartmentId(data))
        || memberHasDepartment(member, docTargetDepartmentId(data));
    }

    function inMemberLocation(member, data) {
      return memberHasLocation(member, docLocationId(data));
    }

    function canReadDoc(orgId, uid, data) {
      let member = activeMemberData(orgId, uid);
      return member != null
        && (organizationIdMatchesDoc(orgId, data) || !('organizationId' in data))
        && (
          member.role in ["super_admin", "admin", "mantenimiento", "auditor"]
          || (member.role in ["jefe_departamento"] && (inMemberDepartment(member, data) || isCreator(uid, data) || isAssignee(uid, data)))
          || (member.role in ["jefe_ubicacion"] && (inMemberLocation(member, data) || isCreator(uid, data) || isAssignee(uid, data)))
          || (member.role in ["operario"] && (isCreator(uid, data) || isAssignee(uid, data) || inMemberDepartment(member, data)))
        );
    }
    function canCreateDoc(orgId, uid, data) {
      let member = activeMemberData(orgId, uid);
      return member != null
        && organizationIdMatchesDoc(orgId, data)
        && isCreator(uid, data)
        && (
          member.role in ["super_admin", "admin", "mantenimiento"]
          || member.role == "jefe_departamento"
          || (member.role == "jefe_ubicacion" && inMemberLocation(member, data))
          || (member.role == "operario" && inMemberLocation(member, data))
        );
    }

    function canUpdateDoc(orgId, uid, currentData) {
      let member = activeMemberData(orgId, uid);
      return member != null
        && (organizationIdMatchesDoc(orgId, currentData) || !('organizationId' in currentData))
        && (
          member.role in ["super_admin", "admin", "mantenimiento"]
          || (member.role in ["jefe_departamento"] && inMemberDepartment(member, currentData))
          || (member.role in ["jefe_ubicacion"] && inMemberLocation(member, currentData))
          || (member.role in ["operario"] && (isCreator(uid, currentData) || isAssignee(uid, currentData) || inMemberDepartment(member, currentData)))
        );
    }

    // Update safety helpers (avoid relying on request.resource.data containing full document)
    function changedKeys() {
      return request.resource.data.diff(resource.data).changedKeys();
    }

    // Core immutable keys: never allow client to change these via update.
    function coreImmutableKeysUnchanged() {
      return !changedKeys().hasAny(["createdBy", "createdAt", "organizationId"]);
    }

    function memberDepartmentIds(member) {
      return member == null
        ? []
        : (('departmentIds' in member) ? member.departmentIds :
            (('departmentId' in member && member.departmentId != null) ? [member.departmentId] : []));
    }

    function memberLocationIds(member) {
      return member == null
        ? []
        : (('locationIds' in member) ? member.locationIds :
            (('locationId' in member && member.locationId != null) ? [member.locationId] : []));
    }

    function membersShareDepartment(a, b) {
      return memberDepartmentIds(a).hasAny(memberDepartmentIds(b));
    }

    function membersShareLocation(a, b) {
      return memberLocationIds(a).hasAny(memberLocationIds(b));
    }

    function canAssignToUser(orgId, actorUid, targetUid) {
      let actor = activeMemberData(orgId, actorUid);
      let target = activeMemberData(orgId, targetUid);
      return actor != null
        && target != null
        && (
          actor.role in ["super_admin", "admin", "mantenimiento"]
          || (actor.role == "jefe_departamento" && membersShareDepartment(actor, target))
          || (actor.role == "jefe_ubicacion" && membersShareLocation(actor, target))
        );
    }

    function assignmentChangeAllowed(orgId, actorUid) {
      let actor = activeMemberData(orgId, actorUid);
      let nextAssignedTo = ("assignedTo" in request.resource.data) ? request.resource.data.assignedTo : null;
      let target = (nextAssignedTo != null && nextAssignedTo != "") ? activeMemberData(orgId, nextAssignedTo) : null;
      let isChanging = changedKeys().hasAny(["assignedTo"]);
      let isClearing = isChanging && (nextAssignedTo == null || nextAssignedTo == "");
      let canClear = actor != null && actor.role in ["super_admin", "admin", "mantenimiento"];
      let actorCanAssign = actor != null
        && target != null
        && (
          actor.role in ["super_admin", "admin", "mantenimiento"]
          || (actor.role == "jefe_departamento" && membersShareDepartment(actor, target))
          || (actor.role == "jefe_ubicacion" && membersShareLocation(actor, target))
        );
      return !isChanging || (isClearing ? canClear : actorCanAssign);

    }

    function operarioUpdateAllowed(orgId, uid, currentData) {
      let member = activeMemberData(orgId, uid);
      let isOperario = member != null && member.role == "operario";
      let creatorOrAssignee = isCreator(uid, currentData) || isAssignee(uid, currentData);
      let isReportingOnly = changedKeys().hasOnly(["reports", "updatedAt"]);
      return member != null
        && (
          !isOperario
          || creatorOrAssignee
          || isReportingOnly
        );

    }

    /* ------------------------------
       USERS (profile)
       - Only self-access from client.
       - Org changes are performed server-side via Cloud Function.
    --------------------------------- */
    match /users/{userId} {
      // Needed by v13 UI (tasks/incidents assignment, name maps, etc.)
      // Allow reading user docs within the caller's active organization.
      // Note: client queries are always scoped with where('organizationId'=='<activeOrgId>').
      allow read: if isSignedIn() && (
        request.auth.uid == userId
        || (resource.data.organizationId is string && isMaintenanceInOrg(resource.data.organizationId, request.auth.uid))
      );

      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.organizationId == null
        && userQuotaFieldsUnset();
        allow update: if isSignedIn()
        && request.auth.uid == userId
        && organizationIdUnchanged()
        && roleUnchanged()
        && userQuotaFieldsUnchanged();

      allow delete: if false;
    }

    /* ------------------------------
       MEMBERSHIPS
       - Users can read their own memberships across orgs.
       - Write operations are server-only.
    --------------------------------- */
    match /memberships/{membershipId} {
      allow read: if isSignedIn()
        && resource.data.userId == request.auth.uid;
      allow create, update, delete: if false;
    }

    /* ------------------------------
       ORGANIZATIONS
       - Block discovery.
       - Read allowed only for active members.
       - Writes server-only.
    --------------------------------- */
    match /organizations/{orgId} {
      allow list: if false;
      allow get: if isSignedIn() && isActiveMember(orgId, request.auth.uid);
      allow create, update, delete: if false;

      // Organization-scoped settings
      match /settings/{settingId} {
        // Readable by active members so the client can gate UX.
        // Writable only by super_admin (Org configuration).
        allow read: if isSignedIn() && isActiveMember(orgId, request.auth.uid);
        allow write: if isSignedIn()
          && isSuperAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
      }

      // Canonical organization membership records.
      // Read access is required by the web client to resolve scoped permissions and assignee lists.
      // Writes remain server-only to avoid privilege escalation from the client.
      match /members/{memberId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);

        allow create, update, delete: if false;
      }

      // Short-lived upload sessions (used to harden Storage writes before an incident exists).
      // Client creates a session owned by itself, uploads files, then creates the ticket and deletes the session.
      match /uploadSessions/{sessionId} {
        allow get: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && (resource.data.uploaderUid == request.auth.uid || isAdminInOrg(orgId, request.auth.uid));
        allow list: if false;

        // Server-only writes (created by Cloud Functions).
        allow create, update, delete: if false;
      }

      // Organization-scoped resources (v14+ data model)
      match /sites/{siteId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /assets/{assetId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /departments/{departmentId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /tickets/{ticketId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId)
          && canReadDoc(orgId, request.auth.uid, resource.data);
        // Server-only writes: hardened to enforce entitlements and open-count consistency.
        allow create, update, delete: if false;
      }

      match /tasks/{taskId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId)
          && canReadDoc(orgId, request.auth.uid, resource.data);
        // Server-only writes: hardened to enforce entitlements and open-count consistency.
        allow create, update, delete: if false;
      }

      match /preventiveTemplates/{templateId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);

        // Server-only writes: prevent bypassing schema/entitlement/nextRunAt logic.
        allow create, update, delete: if false;
      }

    } // match /organizations/{orgId}

  } // match /databases/{database}/documents

} // service cloud.firestore
