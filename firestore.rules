// firestore.rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ------------------------------
       Helpers
       NOTE:
       - Multi-org access is based exclusively on organizations/{orgId}/members/{uid}.
       - Do not rely on users/{uid}.organizationId or legacy memberships for access.
    --------------------------------- */
    function isSignedIn() { return request.auth != null; }

    function isValidOrgId(orgId) {
      return orgId is string && orgId.size() > 0;
    }

    function memberDoc(orgId, uid) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(uid));
    }

    function membershipDoc(orgId, uid) {
      return get(/databases/$(database)/documents/memberships/$(uid + "_" + orgId));
    }

    function isActiveMembership(doc) {
      return doc != null
        && doc.data != null
        && (
          doc.data.status == "active"
          || doc.data.active == true
        );
    }

    function isActiveMember(orgId, uid) {
      let member = isValidOrgId(orgId) ? memberDoc(orgId, uid) : null;
      let membership = isValidOrgId(orgId) ? membershipDoc(orgId, uid) : null;
      return isSignedIn()
        && (
          isActiveMembership(member)
          || isActiveMembership(membership)
        );
    }

    function hasRole(orgId, uid, roles) {
      let member = isValidOrgId(orgId) ? memberDoc(orgId, uid) : null;
      let membership = isValidOrgId(orgId) ? membershipDoc(orgId, uid) : null;
      return isSignedIn()
        && (
          (isActiveMembership(member) && member.data.role in roles)
          || (isActiveMembership(membership) && membership.data.role in roles)
        );
    }

    function hasScope(orgId, uid, locationId) {
      // Admin-like roles are not scope-limited (rules language has no 'if' statement).
      let member = isValidOrgId(orgId) ? memberDoc(orgId, uid) : null;
      return isAdminInOrg(orgId, uid)
        || locationId == null
        || locationId == ""
        || (
          member != null
          && member.data != null
          && (
            member.data.siteId == locationId
            || member.data.departmentId == locationId
            || locationId in (member.data.siteIds != null ? member.data.siteIds : [])
            || locationId in (member.data.departmentIds != null ? member.data.departmentIds : [])
          )
        );
    }

    function isSuperAdminInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["super_admin"]);
    }

    function isAdminInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["admin", "super_admin"]);
    }

    // Role groups (basic rentable + backward compatible)
    function isAuditorInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["auditor"]);
    }

    function isOperatorInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["operator", "operario"]);
    }

    function isDepartmentHeadInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["dept_head_multi", "dept_head_single", "jefe_departamento"]);
    }

    function isLocationHeadInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["jefe_ubicacion", "site_head", "location_head"]);
    }

    function isMaintenanceOnlyInOrg(orgId, uid) {
      return hasRole(orgId, uid, ["maintenance", "mantenimiento"]);
    }

    function isMaintenanceInOrg(orgId, uid) {
      // Legacy helper used across rules: includes admin + scoped heads.
      return hasRole(orgId, uid, [
        "maintenance",
        "mantenimiento",
        "admin",
        "super_admin",
        "dept_head_multi",
        "dept_head_single",
        "jefe_departamento",
        "jefe_ubicacion",
        "site_head",
        "location_head"
      ]);
    }

    function changedKeys() {
      return request.resource.data.diff(resource.data).changedKeys();
    }

    function operatorTicketUpdateAllowedKeys() {
      return [
        "status",
        "updatedAt",
        "lastCommentAt",
        "photoUrls",
        "reports",
        "waiting",
        "closureRequestedBy",
        "closureRequestedAt",
        "closedAt",
        "closedBy",
        "closedReason",
        "reopened",
        "reopenedBy",
        "reopenedAt"
      ];
    }

    function operatorTaskUpdateAllowedKeys() {
      return [
        "status",
        "updatedAt",
        "reports",
        "closedAt",
        "closedBy",
        "closedReason"
      ];
    }

    function taskDepartmentScopeId(data) {
      // Legacy tasks store department selection in "location".
      return (('departmentId' in data) ? data.departmentId : (('location' in data) ? data.location : null));
    }

    function taskSiteScopeId(data) {
      return ('siteId' in data) ? data.siteId : null;
    }

    function canOperatorUpdateTicket(orgId, uid) {
      return isOperatorInOrg(orgId, uid)
        && (resource.data.createdBy == uid || resource.data.assignedTo == uid || hasScope(orgId, uid, resource.data.departmentId) || hasScope(orgId, uid, resource.data.siteId))
        && changedKeys().hasOnly(operatorTicketUpdateAllowedKeys());
    }

    function canOperatorUpdateTask(orgId, uid) {
      return isOperatorInOrg(orgId, uid)
        && (resource.data.createdBy == uid || resource.data.assignedTo == uid)
        && changedKeys().hasOnly(operatorTaskUpdateAllowedKeys());
    }

    function organizationIdUnchanged() {
      return !('organizationId' in resource.data)
        || !('organizationId' in request.resource.data)
        || request.resource.data.organizationId == resource.data.organizationId;
    }

    function organizationIdMatchesPath(orgId) {
      return !('organizationId' in request.resource.data)
        || request.resource.data.organizationId == orgId;
    }

    function resourceOrganizationIdMatchesPath(orgId) {
      return !('organizationId' in resource.data)
        || resource.data.organizationId == orgId;
    }

    function roleUnchanged() {
      return request.resource.data.role == resource.data.role;
    }

    function accountPlanUnchanged() {
      return request.resource.data.accountPlan == resource.data.accountPlan;
    }

    function createdOrganizationsCountUnchanged() {
      return request.resource.data.createdOrganizationsCount == resource.data.createdOrganizationsCount;
    }

    function createdOrganizationsLimitUnchanged() {
      return request.resource.data.createdOrganizationsLimit == resource.data.createdOrganizationsLimit;
    }

    function demoUsedAtUnchanged() {
      return request.resource.data.demoUsedAt == resource.data.demoUsedAt;
    }

    function userQuotaFieldsUnchanged() {
      return accountPlanUnchanged()
        && createdOrganizationsCountUnchanged()
        && createdOrganizationsLimitUnchanged()
        && demoUsedAtUnchanged();
    }

    function userQuotaFieldsUnset() {
      return request.resource.data.accountPlan == null
        && request.resource.data.createdOrganizationsCount == null
        && request.resource.data.createdOrganizationsLimit == null
        && request.resource.data.demoUsedAt == null;
    }

    /* ------------------------------
       USERS (profile)
       - Only self-access from client.
       - Org changes are performed server-side via Cloud Function.
    --------------------------------- */
    match /users/{userId} {
      // Needed by v13 UI (tasks/incidents assignment, name maps, etc.)
      // Allow reading user docs within the caller's active organization.
      // Note: client queries are always scoped with where('organizationId'=='<activeOrgId>').
      allow read: if isSignedIn() && (
        request.auth.uid == userId
        || (resource.data.organizationId is string && isMaintenanceInOrg(resource.data.organizationId, request.auth.uid))
      );

      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.organizationId == null
        && userQuotaFieldsUnset();

      allow update: if isSignedIn()
        && request.auth.uid == userId
        && organizationIdUnchanged()
        && roleUnchanged()
        && userQuotaFieldsUnchanged();

      allow delete: if false;
    }

    /* ------------------------------
       MEMBERSHIPS
       - Users can read their own memberships across orgs.
       - Write operations are server-only.
    --------------------------------- */
    match /memberships/{membershipId} {
      allow read: if isSignedIn()
        && resource.data.userId == request.auth.uid;
      allow create, update, delete: if false;
    }

    /* ------------------------------
       ORGANIZATIONS
       - Block discovery.
       - Read allowed only for active members.
       - Writes server-only.
    --------------------------------- */
    match /organizations/{orgId} {
      allow list: if false;
      allow get: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      allow create, update, delete: if false;

      // Organization-scoped settings
      match /settings/{settingId} {
        // Readable by active members so the client can gate UX.
        // Writable only by super_admin (Org configuration).
        allow read: if isSignedIn() && isActiveMember(orgId, request.auth.uid);
        allow write: if isSignedIn()
          && isSuperAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
      }

      // Organization-scoped resources (v14+ data model)
      match /sites/{siteId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /assets/{assetId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /departments/{departmentId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /tickets/{ticketId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId)
          && (
            // Global operators
            isAdminInOrg(orgId, request.auth.uid)
            || (
              // Scoped operators (maintenance + heads)
              (isMaintenanceOnlyInOrg(orgId, request.auth.uid) || isDepartmentHeadInOrg(orgId, request.auth.uid) || isLocationHeadInOrg(orgId, request.auth.uid))
              && hasScope(orgId, request.auth.uid, ('siteId' in request.resource.data) ? request.resource.data.siteId : (('siteId' in resource.data) ? resource.data.siteId : null))
              && hasScope(orgId, request.auth.uid, ('departmentId' in request.resource.data) ? request.resource.data.departmentId : (('departmentId' in resource.data) ? resource.data.departmentId : null))
            )
            || (
              // Operario: updates limitados (comentarios/evidencias/estado) en asignadas/creadas o en su alcance
              isOperatorInOrg(orgId, request.auth.uid)
              && isActiveMember(orgId, request.auth.uid)
              && (
                resource.data.createdBy == request.auth.uid
                || resource.data.assignedTo == request.auth.uid
                || hasScope(orgId, request.auth.uid, ('siteId' in resource.data) ? resource.data.siteId : null)
                || hasScope(orgId, request.auth.uid, ('departmentId' in resource.data) ? resource.data.departmentId : null)
              )
              && changedKeys().hasOnly(operatorTicketUpdateAllowedKeys())
            )
          );
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /tasks/{taskId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId)
          && (
            // Admin can create any task
            isAdminInOrg(orgId, request.auth.uid)
            || (
              // Maintenance / heads can create in-scope
              (isMaintenanceOnlyInOrg(orgId, request.auth.uid) || isDepartmentHeadInOrg(orgId, request.auth.uid) || isLocationHeadInOrg(orgId, request.auth.uid))
              && hasScope(orgId, request.auth.uid, taskSiteScopeId(request.resource.data))
              && hasScope(orgId, request.auth.uid, taskDepartmentScopeId(request.resource.data))
            )
            || (
              // Operario can create tasks but must be the creator.
              isOperatorInOrg(orgId, request.auth.uid)
              && (('createdBy' in request.resource.data) && request.resource.data.createdBy == request.auth.uid)
            )
          );
        allow update: if isSignedIn()
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId)
          && (
            // Admin can update any task
            isAdminInOrg(orgId, request.auth.uid)
            || (
              // Maintenance / heads can update in-scope
              (isMaintenanceOnlyInOrg(orgId, request.auth.uid) || isDepartmentHeadInOrg(orgId, request.auth.uid) || isLocationHeadInOrg(orgId, request.auth.uid))
              && hasScope(orgId, request.auth.uid, taskSiteScopeId(request.resource.data))
              && hasScope(orgId, request.auth.uid, taskDepartmentScopeId(request.resource.data))
            )
            || (
              // Operario: updates limitados (seguimiento + cierre) en creadas o asignadas
              isOperatorInOrg(orgId, request.auth.uid)
              && (
                resource.data.createdBy == request.auth.uid
                || resource.data.assignedTo == request.auth.uid
              )
              && changedKeys().hasOnly(operatorTaskUpdateAllowedKeys())
            )
          );
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /preventiveTemplates/{templateId} {
        allow read: if isSignedIn()
          && isActiveMember(orgId, request.auth.uid)
          && resourceOrganizationIdMatchesPath(orgId);
        allow create: if isSignedIn()
          && isMaintenanceInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update: if isSignedIn()
          && isMaintenanceInOrg(orgId, request.auth.uid)
          && organizationIdUnchanged()
          && resourceOrganizationIdMatchesPath(orgId);
        allow delete: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
      }

      match /auditLogs/{logId} {
        allow read: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
        allow create: if isSignedIn()
          && isAdminInOrg(orgId, request.auth.uid)
          && organizationIdMatchesPath(orgId);
        allow update, delete: if false;
      }

      // Members snapshot (operational listing)
      match /members/{memberUid} {
        // Read access is required for assignment UX and name resolution.
        // Keep it limited to admin/maintenance/heads.
        allow read: if isSignedIn() && (
          isAdminInOrg(orgId, request.auth.uid)
          || isMaintenanceOnlyInOrg(orgId, request.auth.uid)
          || isDepartmentHeadInOrg(orgId, request.auth.uid)
          || isLocationHeadInOrg(orgId, request.auth.uid)
        );
        allow create, update, delete: if false;
      }

      // Billing providers are server-only (no client read/write).
      match /billingProviders/{providerId} {
        allow read: if isSignedIn() && isAdminInOrg(orgId, request.auth.uid);
        allow create, update, delete: if false;
      }

      // Join requests (pending access)
      match /joinRequests/{requestUid} {
        allow get: if isSignedIn() && (
          isSuperAdminInOrg(orgId, request.auth.uid) ||
          request.auth.uid == requestUid
        );

        allow list: if isSuperAdminInOrg(orgId, request.auth.uid);

        allow create, update, delete: if false;
      }
    }

    /* ------------------------------
       ORGANIZATIONS PUBLIC
       - Read-only public metadata for signup validation.
       - Writes server-only.
    --------------------------------- */
    match /organizationsPublic/{orgId} {
      allow read: if true;
      allow create, update, delete: if false;
    }

    /* ------------------------------
       ROOT-LEVEL SETTINGS (removed)
    --------------------------------- */
  }
}
