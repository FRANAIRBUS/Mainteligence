rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------- Helpers ----------------
    function isSignedIn() { return request.auth != null; }

    function userPath(uid) {
      return /databases/$(database)/documents/users/$(uid);
    }

    function userExists(uid) {
      return exists(userPath(uid));
    }

    function userDoc(uid) {
      return get(userPath(uid));
    }

    function userOrg(uid) {
      return userExists(uid) ? userDoc(uid).data.organizationId : null;
    }

    function userRole(uid) {
      return userExists(uid) ? userDoc(uid).data.role : null;
    }

    function userDept(uid) {
      return userExists(uid) ? userDoc(uid).data.departmentId : null;
    }

    function myOrg() { return userOrg(request.auth.uid); }
    function myRole() { return userRole(request.auth.uid); }
    function myDept() { return userDept(request.auth.uid); }

    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }

    // Roles reales de la app
    function isSuperAdmin() { return isSignedIn() && myRole() == 'super_admin'; }
    function isAdminRole() { return isSignedIn() && (myRole() == 'admin' || myRole() == 'super_admin'); }
    function isMaintenance() { return isSignedIn() && myRole() == 'maintenance'; }
    function isOperator() { return isSignedIn() && myRole() == 'operator'; }

    // Accesos
    function canManageUsers() { return isSuperAdmin(); } // SOLO super_admin cambia roles
    function canAdminOrg() { return isAdminRole() || isMaintenance(); } // admin/super_admin/maintenance

    // Org scoping (SIN bypass por super_admin)
    function orgMatchesOrgId(orgId) {
      return isSignedIn() && myOrg() != null && orgId != null && myOrg() == orgId;
    }

<<<<<<< HEAD
    function organizationIdMatchesResource() {
      return isSignedIn()
        && myOrgId() != null
        && resource.data.organizationId == myOrgId();
    }

    function organizationIdMatchesRequest() {
      return isSignedIn()
        && myOrgId() != null
        && request.resource.data.organizationId == myOrgId();
=======
    function orgMatchesResource() {
      return resource != null
        && resource.data != null
        && resource.data.organizationId != null
        && orgMatchesOrgId(resource.data.organizationId);
    }

    function orgMatchesRequest() {
      return request.resource != null
        && request.resource.data != null
        && request.resource.data.organizationId != null
        && orgMatchesOrgId(request.resource.data.organizationId);
>>>>>>> 3ad751d (fix: org security (no cross-org) + root console pro + v1 functions)
    }

    function orgUnchanged() {
      return request.resource != null
        && resource != null
        && request.resource.data.organizationId == resource.data.organizationId;
    }

    // ---------------- USERS ----------------
    match /users/{userId} {

<<<<<<< HEAD
      // super_admin o admin acceden a usuarios de su organización; cada usuario puede leer su propio perfil
      allow get: if isSignedIn() && (
        request.auth.uid == userId ||
        (isAdmin() && organizationIdMatchesResource())
      );

      // listado de usuarios solo para super_admin o admin de la misma organización
      allow list: if isAdmin() && organizationIdMatchesResource();

      // crear usuarios dentro de la organización; un admin no puede asignar rol super_admin
      allow create: if isSignedIn()
        && (isAdmin() || request.auth.uid == userId)
        && request.resource.data.organizationId == myOrgId()
        && (isSuperAdmin() || request.resource.data.role != 'super_admin');

      // actualizar usuarios dentro de la organización; solo super_admin/admin pueden hacerlo
      // un admin no puede otorgar rol super_admin y nunca se cambia de organización
      allow update: if isSignedIn()
        && isAdmin()
        && organizationIdMatchesResource()
        && organizationIdUnchanged()
        && (isSuperAdmin() || request.resource.data.role != 'super_admin');
=======
      // Permite queries (list) pero solo se devolverán docs permitidos por "read"
      allow list: if isSignedIn();

      // Leer: tú mismo o admin/super_admin/maintenance PERO solo tu org
      allow get: if isSignedIn() && (
        isOwner(userId) ||
        (orgMatchesResource() && (isAdminRole() || isMaintenance()))
      );

      // Crear perfil propio en onboarding.
      // Permitimos role=super_admin SOLO si está creando org nueva (no existe organizations/{orgId})
      allow create: if isSignedIn()
        && isOwner(userId)
        && request.resource.data.organizationId is string
        && request.resource.data.role is string
        && (
          request.resource.data.role != 'super_admin' ||
          !exists(/databases/$(database)/documents/organizations/$(request.resource.data.organizationId))
        );

      // Update:
      // - el owner puede editar su perfil pero NO puede cambiar role ni organizationId
      // - admin/super_admin/maintenance pueden editar usuarios dentro de su org
      // - SOLO super_admin puede cambiar role (y siempre dentro de su org)
      allow update: if isSignedIn()
        && orgMatchesResource()
        && orgUnchanged()
        && (
          (isOwner(userId) &&
            request.resource.data.role == resource.data.role
          )
          ||
          ((isAdminRole() || isMaintenance()) &&
            (
              request.resource.data.role == resource.data.role
              ||
              (canManageUsers())
            )
          )
        );
>>>>>>> 3ad751d (fix: org security (no cross-org) + root console pro + v1 functions)

      // Delete: admin/super_admin dentro de su org (no te borres a ti mismo)
      allow delete: if isSignedIn()
        && orgMatchesResource()
        && isAdminRole()
        && request.auth.uid != userId;
    }

    // ---------------- ORGANIZATIONS ----------------
    match /organizations/{organizationId} {
      // No discovery cross-org
      allow list: if false;

      allow get: if isSignedIn() && orgMatchesOrgId(organizationId);

      // Crear: onboarding (el doc lo crea el flujo). Permite si estás logueado.
      allow create: if isSignedIn();

      // Update/Delete: SOLO super_admin dentro de su org (config empresa)
      allow update, delete: if isSignedIn() && isSuperAdmin() && orgMatchesOrgId(organizationId);

      match /members/{uid} {
        // Lectura: miembros de la org (todos)
        allow read: if isSignedIn() && orgMatchesOrgId(organizationId);

        // Escritura: admin/super_admin/maintenance (gestión interna)
        allow create, update, delete: if isSignedIn() && orgMatchesOrgId(organizationId) && canAdminOrg();
      }
    }

    // ---------------- ORGANIZATIONS PUBLIC ----------------
    match /organizationsPublic/{orgId} {
      // Solo para lookup en signup
      allow read: if true;

      // Recomendado: SOLO super_admin (misma org) o root via Function (Admin SDK).
      // Como este doc es "público", NO dejes que admin normal lo toque si no quieres.
      allow create, update, delete: if isSignedIn() && isSuperAdmin() && orgMatchesOrgId(orgId);
    }

    // ---------------- MEMBERSHIPS ----------------
    match /memberships/{membershipId} {
      // Para queries internas; se filtra por org en el doc
      allow read: if isSignedIn() && orgMatchesResource();

      // Admin/super_admin/maintenance dentro de su org
      allow create, update, delete: if isSignedIn() && canAdminOrg() && orgMatchesRequest();
    }

    // ---------------- SETTINGS ----------------
    match /settings/{settingId} {
<<<<<<< HEAD
      // Solo super_admin puede consultar o modificar la configuración de su organización
      allow read: if isSignedIn() && isSuperAdmin() && organizationIdMatchesResource();
      allow write: if isSignedIn() && isSuperAdmin() && organizationIdMatchesRequest();
=======
      allow read: if isSignedIn() && orgMatchesResource();
      allow write: if isSignedIn() && isSuperAdmin() && orgMatchesRequest();
>>>>>>> 3ad751d (fix: org security (no cross-org) + root console pro + v1 functions)
    }

    // ---------------- TICKETS ----------------
    match /tickets/{ticketId} {
      allow read: if isSignedIn() && orgMatchesResource();

      // Crear: cualquier usuario logueado dentro de su org (recuerda poner organizationId)
      allow create: if isSignedIn() && orgMatchesRequest();

      // Update: operator puede actualizar si es de su dept o está asignado; admin/maintenance full
      allow update: if isSignedIn() && orgMatchesResource() && (
        canAdminOrg()
        ||
        (isOperator() && (
          (resource.data.assignedToUid != null && resource.data.assignedToUid == request.auth.uid)
          ||
          (resource.data.departmentId != null && myDept() != null && resource.data.departmentId == myDept())
        ))
      );

      allow delete: if isSignedIn() && orgMatchesResource() && isAdminRole();
    }

    // ---------------- TASKS ----------------
    match /tasks/{taskId} {
      allow read: if isSignedIn() && orgMatchesResource();

      // Crear tasks: admin/super_admin/maintenance (operario crea tickets, no tasks)
      allow create: if isSignedIn() && orgMatchesRequest() && canAdminOrg();

      // Update: operator si asignada o su dept; admin/maintenance full
      allow update: if isSignedIn() && orgMatchesResource() && (
        canAdminOrg()
        ||
        (isOperator() && (
          (resource.data.assignedToUid != null && resource.data.assignedToUid == request.auth.uid)
          ||
          (resource.data.departmentId != null && myDept() != null && resource.data.departmentId == myDept())
        ))
      );

      allow delete: if isSignedIn() && orgMatchesResource() && isAdminRole();
    }

    // ---------------- SITES / ASSETS / DEPARTMENTS ----------------
    match /sites/{siteId} {
      allow read: if isSignedIn() && orgMatchesResource();
      allow create, update, delete: if isSignedIn() && canAdminOrg() && orgMatchesRequest();
    }

    match /assets/{assetId} {
      allow read: if isSignedIn() && orgMatchesResource();
      allow create, update, delete: if isSignedIn() && canAdminOrg() && orgMatchesRequest();
    }

    match /departments/{departmentId} {
      allow read: if isSignedIn() && orgMatchesResource();
      allow create, update, delete: if isSignedIn() && canAdminOrg() && orgMatchesRequest();
    }
  }
}
