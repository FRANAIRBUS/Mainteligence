// firestore.rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Helpers ----------
    function isSignedIn() { return request.auth != null; }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function myOrgId() {
      return isSignedIn() ? userDoc(request.auth.uid).data.organizationId : null;
    }

    function myRole() {
      return isSignedIn() ? userDoc(request.auth.uid).data.role : null;
    }

    function isSuperAdmin() { return isSignedIn() && myRole() == 'super_admin'; }
    function isAdmin() { return isSignedIn() && (myRole() == 'admin' || myRole() == 'super_admin'); }
    function isManager() { return isSignedIn() && (myRole() == 'super_admin' || myRole() == 'admin' || myRole() == 'maintenance'); }

    function isMemberOfOrg(orgId) {
      return isSignedIn() && myOrgId() != null && myOrgId() == orgId;
    }

    function organizationIdMatchesResource() {
      return isSignedIn()
        && myOrgId() != null
        && resource.data.organizationId == myOrgId();
    }

    function organizationIdMatchesRequest() {
      return isSignedIn()
        && myOrgId() != null
        && request.resource.data.organizationId == myOrgId();
    }

    function organizationIdUnchanged() {
      return request.resource.data.organizationId == resource.data.organizationId;
    }

    function roleUnchanged() {
      return request.resource.data.role == resource.data.role;
    }

    // ---------- USERS ----------
    match /users/{userId} {

      // super_admin o admin acceden a usuarios de su organización; cada usuario puede leer su propio perfil
      allow get: if isSignedIn() && (
        request.auth.uid == userId ||
        (isAdmin() && organizationIdMatchesResource())
      );

      // listado de usuarios solo para super_admin o admin de la misma organización
      allow list: if isAdmin() && organizationIdMatchesResource();

      // crear usuarios dentro de la organización; un admin no puede asignar rol super_admin
      allow create: if isSignedIn()
        && (isAdmin() || request.auth.uid == userId)
        && request.resource.data.organizationId == myOrgId()
        && (isSuperAdmin() || request.resource.data.role != 'super_admin');

      // actualizar usuarios dentro de la organización; solo super_admin/admin pueden hacerlo
      // un admin no puede otorgar rol super_admin y nunca se cambia de organización
      allow update: if isSignedIn()
        && isAdmin()
        && organizationIdMatchesResource()
        && organizationIdUnchanged()
        && (isSuperAdmin() || request.resource.data.role != 'super_admin');

      // delete: opcional, lo dejamos limitado
      allow delete: if false;
    }

    // ---------- MEMBERSHIPS ----------
    match /memberships/{membershipId} {
      allow get: if isSignedIn() && (organizationIdMatchesResource() || request.auth.uid == resource.data.userId);
      allow list: if false;

      // roles NO se tocan desde cliente
      allow create, update, delete: if false;
    }

    // ---------- ORGANIZATIONS ----------
    match /organizations/{organizationId} {
      // bloquear descubrimiento
      allow list: if false;

      allow get: if isMemberOfOrg(organizationId);

      // crear org: permitido para onboarding, pero el doc debe ser coherente
      allow create: if isSignedIn() && request.resource.data.organizationId == organizationId;

      // settings de empresa: SOLO super_admin dentro de su org
      allow update, delete: if isSuperAdmin() && isMemberOfOrg(organizationId);

      match /members/{userId} {
        // miembros visibles sólo dentro de su org
        allow get, list: if isMemberOfOrg(organizationId);

        // NO escribir desde cliente (ni roles ni altas): lo hace servidor / migraciones / CF
        allow create, update, delete: if false;
      }

      match /joinRequests/{requestId} {
        allow get: if isSignedIn() && (request.auth.uid == requestId || isMemberOfOrg(organizationId));
        allow list: if false;
        allow create, update, delete: if false;
      }
    }

    // ---------- ORGANIZATIONS PUBLIC ----------
    match /organizationsPublic/{organizationId} {
      allow read: if true;

      // editable SOLO por super_admin de ESA org (si lo usas desde cliente)
      // si prefieres que ni eso: ponlo en false y que lo toque solo Cloud Function.
      allow create, update, delete: if isSuperAdmin() && isMemberOfOrg(organizationId);
    }

    // ---------- SETTINGS ----------
    match /settings/{settingId} {
      // Solo super_admin puede consultar o modificar la configuración de su organización
      allow read: if isSignedIn() && isSuperAdmin() && organizationIdMatchesResource();
      allow write: if isSignedIn() && isSuperAdmin() && organizationIdMatchesRequest();
    }

    // ---------- TICKETS ----------
    match /tickets/{ticketId} {
      allow read: if isSignedIn() && organizationIdMatchesResource();
      allow create: if isSignedIn() && organizationIdMatchesRequest();
      allow update: if isSignedIn() && organizationIdMatchesResource();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    // ---------- TASKS ----------
    match /tasks/{taskId} {
      allow read: if isSignedIn() && organizationIdMatchesResource();
      allow create: if isSignedIn() && organizationIdMatchesRequest();
      allow update: if isSignedIn() && organizationIdMatchesResource();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    // ---------- SITES / ASSETS / DEPARTMENTS ----------
    match /sites/{siteId} {
      allow read: if isSignedIn() && organizationIdMatchesResource();
      allow create, update: if isAdmin() && organizationIdMatchesRequest();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    match /assets/{assetId} {
      allow read: if isSignedIn() && organizationIdMatchesResource();
      allow create, update: if isAdmin() && organizationIdMatchesRequest();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    match /departments/{departmentId} {
      allow read: if isSignedIn() && organizationIdMatchesResource();
      allow create, update: if isAdmin() && organizationIdMatchesRequest();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }
  }
}
