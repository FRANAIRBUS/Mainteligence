rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------
    // Helpers
    // -----------------------------
    function isSignedIn() { return request.auth != null; }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function myOrgId() {
      return userDoc(request.auth.uid).data.organizationId;
    }

    function myRole() {
      return userDoc(request.auth.uid).data.role;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Roles (accept both old/new variants used by the app)
    function isSuperAdmin() {
      return isSignedIn() && (myRole() == 'super_admin');
    }

    function isAdmin() {
      return isSignedIn() && (myRole() == 'admin' || myRole() == 'super_admin');
    }

    function isMaintenance() {
      return isSignedIn() && (myRole() == 'maintenance');
    }

    function isManager() {
      // Used for user/member management screens
      return isAdmin() || isMaintenance();
    }

    function isMemberOfOrg(orgId) {
      return isSignedIn() && myOrgId() != null && myOrgId() == orgId;
    }

    // Hard org isolation (NO cross-org bypass for any role)
    function organizationIdMatchesResource() {
      return isSignedIn()
        && myOrgId() != null
        && resource.data.organizationId != null
        && resource.data.organizationId == myOrgId();
    }

    function organizationIdMatchesRequest() {
      return isSignedIn()
        && myOrgId() != null
        && request.resource.data.organizationId != null
        && request.resource.data.organizationId == myOrgId();
    }

    function organizationIdUnchanged() {
      return request.resource.data.organizationId == resource.data.organizationId;
    }

    // -----------------------------
    // USERS (profile + role)
    // -----------------------------
    match /users/{userId} {

      // Read your own profile. Managers can read users of their org.
      allow get: if isSignedIn() && (
        isOwner(userId) ||
        (isManager() && organizationIdMatchesResource())
      );

      // Allow list only for managers. Queries MUST be constrained by organizationId == myOrgId()
      // otherwise Firestore will reject the query automatically.
      allow list: if isManager();

      // Users can create their own profile (e.g., on first login).
      // Do NOT allow creating yourself as super_admin.
      allow create: if isSignedIn()
        && isOwner(userId)
        && request.resource.data.organizationId != null
        && request.resource.data.role != 'super_admin';

      // Owner can edit their profile (but never role/org).
      // Admins can edit users inside org (active/department/etc), but cannot change role.
      // Only super_admin can change role (still inside same org, and orgId cannot change).
      allow update: if isSignedIn()
        && organizationIdMatchesResource()
        && organizationIdUnchanged()
        && (
          (isOwner(userId) && request.resource.data.role == resource.data.role) ||
          (isAdmin() && request.resource.data.role == resource.data.role) ||
          (isSuperAdmin())
        );

      // Admins can delete users inside org (not self).
      allow delete: if isAdmin()
        && organizationIdMatchesResource()
        && request.auth.uid != userId;
    }

    // -----------------------------
    // MEMBERSHIPS (global mapping, must have organizationId field)
    // -----------------------------
    match /memberships/{membershipId} {
      allow get, list: if isSignedIn() && organizationIdMatchesResource();
      allow create: if isAdmin() && organizationIdMatchesRequest();
      allow update, delete: if isAdmin() && organizationIdMatchesResource() && organizationIdUnchanged();
    }

    // -----------------------------
    // ORGANIZATIONS (one doc per org, docId == organizationId)
    // -----------------------------
    match /organizations/{organizationId} {

      // Prevent org discovery from client
      allow list: if false;

      // Only members can read their own org
      allow get: if isMemberOfOrg(organizationId);

      // Allow creating org docs during signup.
      // (Your client must still write the org doc with the correct id.)
      allow create: if isSignedIn();

      // Only super_admin of that org can update/delete org settings
      allow update, delete: if isSuperAdmin() && isMemberOfOrg(organizationId);

      // Members subcollection (docId == uid)
      match /members/{userId} {
        allow get, list: if isSignedIn() && isMemberOfOrg(organizationId);
        // Admins can manage members inside org (role/active/department in this doc)
        allow create, update, delete: if isAdmin() && isMemberOfOrg(organizationId);
      }
    }

    // -----------------------------
    // ORGANIZATIONS PUBLIC (public landing/meta)
    // -----------------------------
    match /organizationsPublic/{organizationId} {
      allow get, list: if true;
      // Only super_admin of that org can edit public org profile
      allow create, update, delete: if isSuperAdmin() && isMemberOfOrg(organizationId);
    }

    // -----------------------------
    // SETTINGS (per-org docs with organizationId field)
    // -----------------------------
    match /settings/{settingId} {
      // Only super_admin should access company settings / AI assistant settings screens
      allow get, list: if isSuperAdmin() && organizationIdMatchesResource();
      allow create, update, delete: if isSuperAdmin() && organizationIdMatchesRequest() && (resource == null || organizationIdUnchanged());
    }

    // -----------------------------
    // CORE RESOURCES (top-level collections with organizationId field)
    // -----------------------------
    match /tickets/{ticketId} {
      allow get, list: if isSignedIn() && organizationIdMatchesResource();
      allow create: if isSignedIn() && organizationIdMatchesRequest();
      allow update: if isSignedIn() && organizationIdMatchesResource() && organizationIdUnchanged();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    match /tasks/{taskId} {
      allow get, list: if isSignedIn() && organizationIdMatchesResource();
      allow create: if isSignedIn() && organizationIdMatchesRequest();
      allow update: if isSignedIn() && organizationIdMatchesResource() && organizationIdUnchanged();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    match /sites/{siteId} {
      allow get, list: if isSignedIn() && organizationIdMatchesResource();
      allow create: if isAdmin() && organizationIdMatchesRequest();
      allow update: if isAdmin() && organizationIdMatchesResource() && organizationIdUnchanged();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    match /assets/{assetId} {
      allow get, list: if isSignedIn() && organizationIdMatchesResource();
      allow create: if isAdmin() && organizationIdMatchesRequest();
      allow update: if isAdmin() && organizationIdMatchesResource() && organizationIdUnchanged();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    match /departments/{departmentId} {
      allow get, list: if isSignedIn() && organizationIdMatchesResource();
      allow create: if isAdmin() && organizationIdMatchesRequest();
      allow update: if isAdmin() && organizationIdMatchesResource() && organizationIdUnchanged();
      allow delete: if isAdmin() && organizationIdMatchesResource();
    }

    // -----------------------------
    // Fallback: deny everything else by default
    // -----------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
