rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- FUNCIONES DE AYUDA (Mantenemos las tuyas) ---
    function isSignedIn() {
      return request.auth != null;
    }

    function getUser(uid) {
      // Nota: He cambiado (default) por $(database) para mayor compatibilidad
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function getUserRole(uid) {
      if (!exists(/databases/$(database)/documents/users/$(uid))) {
        return 'none';
      }
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    function getUserDepartmentId(uid) {
      if (!exists(/databases/$(database)/documents/users/$(uid))) {
        return null;
      }
      return get(/databases/$(database)/documents/users/$(uid)).data.departmentId;
    }

    function isMantenimiento() {
      return isSignedIn() && getUserRole(request.auth.uid) in ['mantenimiento', 'admin'];
    }

    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    function canAccessTicket(ticketId) {
      if (!isSignedIn()) return false;
      let path = /databases/$(database)/documents/tickets/$(ticketId);
      if (!exists(path)) return false;

      let ticketData = get(path).data;

      return isMantenimiento() ||
        ticketData.createdBy == request.auth.uid ||
        ticketData.assignedTo == request.auth.uid ||
        (ticketData.departmentId != null && ticketData.departmentId == getUserDepartmentId(request.auth.uid));
    }

    // --- REGLAS DE CARPETAS ---

    // 1. Logo de la empresa (PÃºblico para lectura)
    match /branding/logo.png {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 2. Fotos de Incidencias (Tickets)
    match /tickets/{ticketId}/{allPaths=**} {
        allow read, write: if canAccessTicket(ticketId);
    }

    // ðŸ‘‡ðŸ‘‡ðŸ‘‡ NUEVO: Fotos de Tareas (Tasks) ðŸ‘‡ðŸ‘‡ðŸ‘‡
    match /tasks/{taskId}/{allPaths=**} {
        // Por ahora permitimos a cualquier usuario logueado subir/ver fotos de tareas
        // Puedes restringirlo mÃ¡s adelante si quieres que solo el asignado pueda subir fotos
        allow read, write: if isSignedIn();
    }
    // ðŸ‘†ðŸ‘†ðŸ‘† FIN DEL BLOQUE NUEVO ðŸ‘†ðŸ‘†ðŸ‘†

    // 3. Avatares de usuario
    match /users/{userId}/avatar.png {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
  }
}
