rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- FUNCIONES DE AYUDA ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isValidOrgId(orgId) {
      return orgId is string && orgId.size() > 0;
    }

    function memberDoc(orgId, uid) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(uid));
    }

    function isActiveMember(orgId, uid) {
      if (!isValidOrgId(orgId)) {
        return false;
      }
      let member = memberDoc(orgId, uid);
      return isSignedIn()
        && member.data != null
        && (
          member.data.status == "active"
          || member.data.active == true
        );
    }

    function ticketBelongsToOrg(orgId, ticketId) {
      if (!isValidOrgId(orgId)) {
        return false;
      }
      let orgPath = /databases/$(database)/documents/organizations/$(orgId)/tickets/$(ticketId);
      return exists(orgPath) && get(orgPath).data.organizationId == orgId;
    }

    function taskBelongsToOrg(orgId, taskId) {
      if (!isValidOrgId(orgId)) {
        return false;
      }
      let orgPath = /databases/$(database)/documents/organizations/$(orgId)/tasks/$(taskId);
      return exists(orgPath) && get(orgPath).data.organizationId == orgId;
    }

    function assetBelongsToOrg(orgId, assetId) {
      if (!isValidOrgId(orgId)) {
        return false;
      }
      let orgPath = /databases/$(database)/documents/organizations/$(orgId)/assets/$(assetId);
      return exists(orgPath) && get(orgPath).data.organizationId == orgId;
    }

    // --- REGLAS DE CARPETAS ---

    // 1. Logo de la empresa
    match /orgs/{orgId}/branding/logo.png {
      allow read: if true;
      allow write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid);
    }

    // 2. Fotos de Incidencias (Tickets)
    match /orgs/{orgId}/tickets/{ticketId}/{allPaths=**} {
      allow read, write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && ticketBelongsToOrg(orgId, ticketId);
    }

    // 3. Fotos de Tareas (Tasks)
    match /orgs/{orgId}/tasks/{taskId}/{allPaths=**} {
      allow read, write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && taskBelongsToOrg(orgId, taskId);
    }

    // 4. Activos (Assets)
    match /orgs/{orgId}/assets/{assetId}/{allPaths=**} {
      allow read, write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && assetBelongsToOrg(orgId, assetId);
    }

    // 5. Avatares de usuario
    match /users/{userId}/{fileName} {
      allow read: if isSignedIn() && fileName.matches('avatar\\..+');
      allow write: if isSignedIn() && request.auth.uid == userId && fileName.matches('avatar\\..+');
    }
  }
}
