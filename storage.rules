rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- FUNCIONES DE AYUDA (Mantenemos las tuyas) ---
    function isSignedIn() {
      return request.auth != null;
    }

    function getUser(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function getUserRole(uid) {
      if (!exists(/databases/$(database)/documents/users/$(uid))) {
        return 'none';
      }
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    function normalizeRole(role) {
      if (role == 'operario') return 'operator';
      if (role == 'mantenimiento') return 'maintenance';
      return role;
    }

    function userRole(uid) {
      return normalizeRole(getUserRole(uid));
    }

    function getUserDepartmentId(uid) {
      if (!exists(/databases/$(database)/documents/users/$(uid))) {
        return null;
      }
      return get(/databases/$(database)/documents/users/$(uid)).data.departmentId;
    }

    function getUserDepartmentIds(uid) {
      if (!exists(/databases/$(database)/documents/users/$(uid))) {
        return [];
      }
      let deptIds = get(/databases/$(database)/documents/users/$(uid)).data.departmentIds;
      return deptIds == null ? [] : deptIds;
    }

    function getUserOrganizationId(uid) {
      if (!exists(/databases/$(database)/documents/users/$(uid))) {
        return null;
      }
      return get(/databases/$(database)/documents/users/$(uid)).data.organizationId;
    }

    function ticketOriginDepartment(ticketData) {
      return ticketData.originDepartmentId != null ? ticketData.originDepartmentId : ticketData.departmentId;
    }

    function ticketTargetDepartment(ticketData) {
      return ticketData.targetDepartmentId != null ? ticketData.targetDepartmentId : ticketData.departmentId;
    }

    function ticketInScope(ticketData, uid) {
      let primaryDept = getUserDepartmentId(uid);
      let extraDepts = getUserDepartmentIds(uid);
      let originDept = ticketOriginDepartment(ticketData);
      let targetDept = ticketTargetDepartment(ticketData);
      return (primaryDept != null && (originDept == primaryDept || targetDept == primaryDept)) ||
             (extraDepts.size() > 0 && (extraDepts.hasAny([originDept]) || extraDepts.hasAny([targetDept])));
    }

    function canAccessTicket(ticketId) {
      if (!isSignedIn()) return false;
      let path = /databases/$(database)/documents/tickets/$(ticketId);
      if (!exists(path)) return false;

      let ticketData = get(path).data;
      let role = userRole(request.auth.uid);

      if (role == 'super_admin') return true;
      if (!isSignedIn() || ticketData.organizationId != getUserOrganizationId(request.auth.uid)) return false;
      if (role in ['admin', 'maintenance']) return true;
      if (role in ['dept_head_multi', 'dept_head_single']) {
        return ticketInScope(ticketData, request.auth.uid) || ticketData.createdBy == request.auth.uid || ticketData.assignedTo == request.auth.uid;
      }

      return (
        ticketInScope(ticketData, request.auth.uid) ||
        ticketData.createdBy == request.auth.uid ||
        ticketData.assignedTo == request.auth.uid
      );
    }

    // --- REGLAS DE CARPETAS ---

    // 1. Logo de la empresa (PÃºblico para lectura)
    match /branding/logo.png {
      allow read: if true;
      allow write: if isSignedIn() && userRole(request.auth.uid) in ['admin', 'super_admin'];
    }

    // 2. Fotos de Incidencias (Tickets)
    match /tickets/{ticketId}/{allPaths=**} {
        allow read, write: if canAccessTicket(ticketId);
    }

    // ðŸ‘‡ðŸ‘‡ðŸ‘‡ NUEVO: Fotos de Tareas (Tasks) ðŸ‘‡ðŸ‘‡ðŸ‘‡
    match /tasks/{taskId}/{allPaths=**} {
        // Por ahora permitimos a cualquier usuario logueado subir/ver fotos de tareas
        // Puedes restringirlo mÃ¡s adelante si quieres que solo el asignado pueda subir fotos
        allow read, write: if isSignedIn();
    }
    // ðŸ‘†ðŸ‘†ðŸ‘† FIN DEL BLOQUE NUEVO ðŸ‘†ðŸ‘†ðŸ‘†

    // 3. Avatares de usuario
    match /users/{userId}/avatar.png {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
  }
}
