rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- FUNCIONES DE AYUDA ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isValidOrgId(orgId) {
      return orgId is string && orgId.size() > 0;
    }

    function memberDoc(orgId, uid) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(uid));
    }

    function isActiveMember(orgId, uid) {
      if (!isValidOrgId(orgId)) {
        return false;
      }
      let member = memberDoc(orgId, uid);
      return isSignedIn()
        && member.data != null
        && (
          member.data.status == "active"
          || member.data.active == true
        );
    }

    function ticketBelongsToOrg(orgId, ticketId) {
      if (!isValidOrgId(orgId)) {
        return false;
      }
      let orgPath = /databases/$(database)/documents/organizations/$(orgId)/tickets/$(ticketId);
      if (exists(orgPath)) {
        let data = get(orgPath).data;
        return data.organizationId == null || data.organizationId == orgId;
      }
      let legacyPath = /databases/$(database)/documents/tickets/$(ticketId);
      return exists(legacyPath) && get(legacyPath).data.organizationId == orgId;
    }

    function taskBelongsToOrg(orgId, taskId) {
      if (!isValidOrgId(orgId)) {
        return false;
      }
      let orgPath = /databases/$(database)/documents/organizations/$(orgId)/tasks/$(taskId);
      if (exists(orgPath)) {
        let data = get(orgPath).data;
        return data.organizationId == null || data.organizationId == orgId;
      }
      let legacyPath = /databases/$(database)/documents/tasks/$(taskId);
      return exists(legacyPath) && get(legacyPath).data.organizationId == orgId;
    }

    function assetBelongsToOrg(orgId, assetId) {
      if (!isValidOrgId(orgId)) {
        return false;
      }
      let orgPath = /databases/$(database)/documents/organizations/$(orgId)/assets/$(assetId);
      if (exists(orgPath)) {
        let data = get(orgPath).data;
        return data.organizationId == null || data.organizationId == orgId;
      }
      let legacyPath = /databases/$(database)/documents/assets/$(assetId);
      return exists(legacyPath) && get(legacyPath).data.organizationId == orgId;
    }

    // --- REGLAS DE CARPETAS ---

    // 1. Logo de la empresa (legacy public read)
    match /branding/logo.png {
      allow read: if true;
      allow write: if false;
    }

    match /orgs/{orgId}/branding/logo.png {
      allow read: if true;
      allow write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid);
    }

    // 2. Fotos de Incidencias (Tickets)
    match /orgs/{orgId}/tickets/{ticketId}/{allPaths=**} {
      allow read, write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && ticketBelongsToOrg(orgId, ticketId);
    }

    // 3. Fotos de Tareas (Tasks)
    match /orgs/{orgId}/tasks/{taskId}/{allPaths=**} {
      allow read, write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && taskBelongsToOrg(orgId, taskId);
    }

    // 4. Activos (Assets)
    match /orgs/{orgId}/assets/{assetId}/{allPaths=**} {
      allow read, write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && assetBelongsToOrg(orgId, assetId);
    }

    // Legacy paths (read-only during migration)
    match /tickets/{ticketId}/{allPaths=**} {
      allow read: if isSignedIn()
        && exists(/databases/$(database)/documents/tickets/$(ticketId))
        && isActiveMember(get(/databases/$(database)/documents/tickets/$(ticketId)).data.organizationId, request.auth.uid);
      allow write: if false;
    }

    match /tasks/{taskId}/{allPaths=**} {
      allow read: if isSignedIn()
        && exists(/databases/$(database)/documents/tasks/$(taskId))
        && isActiveMember(get(/databases/$(database)/documents/tasks/$(taskId)).data.organizationId, request.auth.uid);
      allow write: if false;
    }

    match /assets/{assetId}/{allPaths=**} {
      allow read: if isSignedIn()
        && exists(/databases/$(database)/documents/assets/$(assetId))
        && isActiveMember(get(/databases/$(database)/documents/assets/$(assetId)).data.organizationId, request.auth.uid);
      allow write: if false;
    }

    // 5. Avatares de usuario
    match /users/{userId}/{fileName} {
      allow read: if isSignedIn() && fileName.matches('avatar\\..+');
      allow write: if isSignedIn() && request.auth.uid == userId && fileName.matches('avatar\\..+');
    }
  }
}
