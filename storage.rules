rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- FUNCIONES DE AYUDA ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isValidOrgId(orgId) {
      return orgId is string && orgId.size() > 0;
    }

    function memberDoc(orgId, uid) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(uid));
    }

    function isActiveMember(orgId, uid) {
      let member = memberDoc(orgId, uid);
      return isSignedIn()
        && isValidOrgId(orgId)
        && member.data != null
        && (
          member.data.active == true
          || member.data.status == "active"
        );
    }

    function ticketBelongsToOrg(orgId, id) {
      return isValidOrgId(orgId)
        && exists(/databases/$(database)/documents/organizations/$(orgId)/tickets/$(id));
    }

    function taskBelongsToOrg(orgId, id) {
      return isValidOrgId(orgId)
        && exists(/databases/$(database)/documents/organizations/$(orgId)/tasks/$(id));
    }

    function assetBelongsToOrg(orgId, id) {
      return isValidOrgId(orgId)
        && exists(/databases/$(database)/documents/organizations/$(orgId)/assets/$(id));
    }

    function isValidImageUpload(maxBytes) {
      return request.resource != null
        && request.resource.size > 0
        && request.resource.size <= maxBytes
        && request.resource.contentType.matches('image/.*');
    }

    // --- REGLAS DE CARPETAS ---

    // 1. Logo de la empresa
    match /orgs/{orgId}/branding/logo.png {
      allow read: if true;
      allow write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && isValidImageUpload(5 * 1024 * 1024);
    }

    // 2. Fotos de Incidencias (Tickets)
    match /orgs/{orgId}/tickets/{ticketId}/{allPaths=**} {
      allow read: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && ticketBelongsToOrg(orgId, ticketId);
      allow write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && ticketBelongsToOrg(orgId, ticketId)
        && isValidImageUpload(10 * 1024 * 1024);
    }

    // 3. Fotos de Tareas (Tasks)
    match /orgs/{orgId}/tasks/{taskId}/{allPaths=**} {
      allow read: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && taskBelongsToOrg(orgId, taskId);
      allow write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && taskBelongsToOrg(orgId, taskId)
        && isValidImageUpload(10 * 1024 * 1024);
    }

    // 4. Activos (Assets)
    match /orgs/{orgId}/assets/{assetId}/{allPaths=**} {
      allow read: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && assetBelongsToOrg(orgId, assetId);
      allow write: if isSignedIn()
        && isValidOrgId(orgId)
        && isActiveMember(orgId, request.auth.uid)
        && assetBelongsToOrg(orgId, assetId)
        && isValidImageUpload(10 * 1024 * 1024);
    }

    // 5. Avatares de usuario
    match /users/{userId}/{fileName} {
      allow read: if isSignedIn() && fileName.matches('avatar\\..+');
      allow write: if isSignedIn()
        && request.auth.uid == userId
        && fileName.matches('avatar\\..+')
        && isValidImageUpload(5 * 1024 * 1024);
    }
  }
}
